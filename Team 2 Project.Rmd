---
title: "Mini Project Team 2"
authors: "By: Cooper, Ricardo, Varun, and Alton"
#date: "today"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    number_sections: false
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r init, include=FALSE}
# some of common options (and the defaults) are: 
# include=T, eval=T, echo=T, results='hide'/'asis'/'markup',..., collapse=F, warning=T, message=T, error=T, cache=T, fig.width=6, fig.height=4, fig.dim=c(6,4) #inches, fig.align='left'/'center','right', 
library(ezids)
library(dplyr)
# knitr::opts_chunk$set(warning = F, results = "markup", message = F)
knitr::opts_chunk$set(warning = F, results = "hide", message = F)
options(scientific=T, digits = 3) 
# options(scipen=9, digits = 3) 
# ‘scipen’: integer. A penalty to be applied when deciding to print numeric values in fixed or exponential notation.  Positive values bias towards fixed and negative towards scientific notation: fixed notation will be preferred unless it is more than ‘scipen’ digits wider.
# use scipen=999 to prevent scientific notation at all times
```

Let's first import our dataset before we do any analysis. Our dataset is based on possible variables that could be used to predict loan default status for employed individuals in India.

```{r loanpredict}
#Import dataset
loanpredict <- read.csv("Training Data.csv", header = TRUE)
str(loanpredict)
#Convert necessary variables to factors/categoricals and set appropriate level titles
loanpredict$Married.Single <- recode_factor(loanpredict$Married.Single, single = "Single", married = "Married")

loanpredict$House_Ownership <- recode_factor(loanpredict$House_Ownership, rented = "Renting", owned = "Owning", norent_noown = "Neither")

loanpredict$Car_Ownership <- recode_factor(loanpredict$Car_Ownership, no = "No", yes = "Yes")

```


Our dataset has a total of `r nrow(loanpredict)` data points and `r ncol(loanpredict)-1` variables that we can use to assess the likelihood of someone defaulting on their loan. That being said, we may want to shrink our dataset down to only the ones that an provide some value in our analysis. Therefore, we'll remove the indexing column "ID" as well as the columns "Profession", "City", and "State" because they have too many distinct values for us to get true value from in our analysis. We will then run a summary analysis to get a better idea of our remaining variables

```{r EDA_basicstats, result = asis}
#Remove variables that won't help in our analysis
loandata <- subset(loanpredict, select = -c(Id, CITY, STATE, Profession))

#Create summary table of remaining variables
xkablesummary(loandata, title = "Summary Statistics for Loan Default Prediction")

```

    
Examining our summary results, we can determine that Marriage Status, House Ownership, and Car Ownership are categorical variables of some interest to us. Income as quite a wide range of possible values with a minimum of `r min(loandpredict$income)` Rupees and a maximum of `r max(loanpredict$income)` rupees. We'll keep this data in the form of Rupees for analysis, but for context this minimum is approximately $\$$`r round(min(loandpredict$income)*0.013, digits=2)` and the maximum is approximately $\$$`r round(max(loandpredict$income)*0.013, digits=2)`.

Before we continue further, let's subset our data depending on if the individual defaulted on their loan or not.

```{r}
#Selecting only values where the customer defaulted
defaulted <- subset(loandata, Risk_Flag == 1)

#Selecting only values where the customer did not default
not_defaulted <- subset(loandata, Risk_Flag == 0)
```

Let's first examine the population of customers who have not defaulted on their loans.
```{r}
#Summary for non-defaulted customers
xkablesummary(not_defaulted, title = "Summary of Data for Non-Defaulted Customers")
```

Looking at the summary data for non-defaulted customers, we can see that the majority of these customers rent their home, own a car, and are not married. Their average age is `r mean(not_defaulted$Age)` years old and they have, on average `r mean(not_defaulted$Experience)` years of experience working. Further, these customers have an average income of `r mean(not_defaulted$Income)` Rupees. These customers also have an average of `r mean(not_defaulted$CURRENT_JOB_YRS)` years working at their current jobs, and have lived in their current houses (or apartments, condos, etc.) for an average of `r mean(not_defaulted$CURRENT_HOUSE_YRS)` years.

```{r}
#Summary for defaulted customers
xkablesummary(defaulted, title = "Summary of Data for Defaulted Customers")
```

For the defaulted customers, we can see that they, like the non-defaulted population, primarily rent, own a car, and are not married. They have an average income of `r mean(defaulted$Income)` Rupees. These customers also have an average of `r mean(defaulted$CURRENT_JOB_YRS)` years working at their current jobs, and have lived in their current houses (or apartments, condos, etc.) for an average of `r mean(defaulted$CURRENT_HOUSE_YRS)` years. Their average age is `r mean(defaulted$Age)` years old and they have, on average `r mean(defaulted$Experience)` years of experience working.

Based on what we're seeing here, we would like to use this dataset to help us answer a few key questions related to defaulting on loans:

	• Do customers who default on loans have statistically lower incomes than those who don't default?
	• Does home-ownership correlate with lower rates of default?
	• Does being married decrease the likelihood of default?
	• Does an additional year of home-ownership reduce the likelihood of default?
	• Does job experience or age show a larger impact on someone defaulting on their loan?
		○ Within that, do job experience and age both negatively correlate with loan defaults?
	• Are customers who default on loans younger than those who do not?

In order to answer these questions, we need to analyze incomes, home-ownership status, marriage status, years in current house, job experience/experience, and age.

Looking at some basic graphs of our data, it's a bit difficult to assess any clear and obvious relationships.
```{r}
#Box-plot
pairs(loandata)
```

So, let's look at the correlation of our variables before we dig in deeper and use our assumptions that drove our questions.
```{r}
#Import necessary library
library(corrplot)

#Subset out numerical variables for correlation analysis
numericalloan = subset(loandata, select = c(Income, Age, Experience, CURRENT_JOB_YRS, CURRENT_HOUSE_YRS, Risk_Flag))

#Run correlation
correlation = cor(numericalloan)

#Make the plot look presentable
corrplot(cor(numericalloan), method = 'circle', type = 'upper', title = "Correlation Plot for Numerical Loan Variables")
```
Examining the correlation plot, we see that Experience and # of years in the job are highly correlated, which is expected. No other variables appear to show strong correlations with each other or with risk flags. We can examine this further as we look into the difference between the the defaulted and non-defaulted populations.

Let's start with income and examine the boxplots of those who defaulted vs. those who did not.
```{r}
#Import necessary library
library("ggplot2")

#Convert Risk_Flag to factor level
loandata$Risk_Flag <- recode_factor(loandata$Risk_Flag, "0" = "Non-Defaulted", "1" = "Defaulted")

ggplot(loandata, aes(x=Risk_Flag, y=Income)) + 
  geom_boxplot( colour="orange", fill="#7777cc", outlier.colour="red", outlier.shape=8, outlier.size=4)+
  labs(title="Income based on Loan Default Status",x="Default Status", y = "Income")


```

Examing these boxplots, we don't see any inherent difference in the income levels for those who have and haven't defaulted on their loans. We will still conduct a statistical test later to confirm that income doesn't differ significantly, but for now we will simply say that it doesn't appear to differ between our populations.

Let's now examine home-ownership rates relative to default status.
```{r}
cont_table_housing <- table(loandata$House_Ownership, loandata$Risk_Flag)
xkabledply(cont_table_housing, title="Contingency table for Home-Ownership vs. Loan Default Status")
```
Looking at our contingency table, we can see that Renting is clearly the most common form of housing for both populations, followed by owning a home, and lastly by neither owning nor renting their home. It's a bit tricky to assess proportions from this, but we will later be conducting a chi-square test to determine if the proportions differ between the two populations.

Next, let's examine marital status vs. loan default status.
```{r}
cont_table_marriage <- table(loandata$Married.Single, loandata$Risk_Flag)
xkabledply(cont_table_marriage, title="Contingency table for Marriage Status vs. Loan Default Status")
```

Again, for both those who have defaulted on their loans and those who haven't, we see that more individuals are single than married. As with home-ownership, it's tricky to determine by eyeing it, whether the proportions differ significantly. Therefore, we will again conduct a chi-square test later, to assess if these are statistically significant differences in proportion.

Next, let's assess years of home-ownership against default status. We'll once again use a box-plot for this.

```{r}
ggplot(loandata, aes(x=Risk_Flag, y=CURRENT_HOUSE_YRS)) + 
  geom_boxplot( colour="orange", fill="#7777cc", outlier.colour="red", outlier.shape=8, outlier.size=4)+
  labs(title="Years in Current House based on Loan Default Status",x="Default Status", y = "Years in Current House")

```

As before with income, we see that the boxplots appear almost identical. We'll have to use a test to determine if there is a statistically significant difference between the years in housing for those who have defaulted on their loans and those who haven't.

Next, we'll assess both experience in the current job and overall job experience relative to loan default status.

```{r}
ggplot(loandata, aes(x=Risk_Flag, y=CURRENT_JOB_YRS)) + 
  geom_boxplot( colour="orange", fill="#7777cc", outlier.colour="red", outlier.shape=8, outlier.size=4)+
  labs(title="Years in Current Job based on Loan Default Status",x="Default Status", y = "Years in Current Job")
```


```{r}
ggplot(loandata, aes(x=Risk_Flag, y=Experience)) + 
  geom_boxplot( colour="orange", fill="#7777cc", outlier.colour="red", outlier.shape=8, outlier.size=4)+
  labs(title="Years Overall Job Experience based on Loan Default Status",x="Default Status", y = "Total Job Experience")
```


Although the top end of the boxplots look relatively similar, it's important to note that in both current job experience and overall job experience, the lower bound of the IQR for defaulted customers, is lower than for non-defaulted customers. As with all of our other variables, we'll conduct testing to determine if this is a significant difference between defaulted and non-defaulted customers.

Lastly, we'll assess the age of customers relative to their loan default status

```{r}
ggplot(loandata, aes(x=Risk_Flag, y=Age)) + 
  geom_boxplot( colour="orange", fill="#7777cc", outlier.colour="red", outlier.shape=8, outlier.size=4)+
  labs(title="Age based on Loan Default Status",x="Default Status", y = "Age")
```

Although the difference appears subtle, we can see that the boxplot for Defaulted customers is slightly lower than for non-defaulted customers. This would imply, potentially, that defaulted customers are slightly younger than non-defaulted customers. We'll again conduct a test to confirm if this hypothesis is correct.


Before we get to our statistical testing, let's confirm our quantitative variables all follow the required normality assumptions. To do that, we'll go ahead and examine a histogram and Q-Q Plot for each variables, make a visual assessment of normality, and then utilize a Shapiro-Wilk test to confirm our assumptions. We will conduct this assessment separately for Defaulted and Non-Defaulted customers to ensure that each population follows the normal distribution.

Let's first begin with our non-defaulted population.

ANALYSIS FOR AGE

ANALYSIS FOR INCOME

ANALYSIS FOR EXPERIENCE

ANALYSIS FOR YEARS OWNING HOME

ANALYSIS FOR YEARS IN CURRENT JOB


Now, let's assess our defaulted population.

ANALYSIS FOR AGE

ANALYSIS FOR INCOME

ANALYSIS FOR EXPERIENCE

ANALYSIS FOR YEARS OWNING HOME

ANALYSIS FOR YEARS IN CURRENT JOB


Having confirmed that our data all follow our assumptions of normality (CHANGE THIS IF IT'S FALSE), we can now conduct our analysis to answer our posed questions.

First, let's analyze the income levels and if they differ significantly for defaulted vs. non-defaulted customers. Given that we are trying to assess if customers who have defaulted have lower incomes than those who haven't, we would set up our hypothesis test as follows:
$H_0$: $\mu_{defaulted} \geq \mu_{not defaulted}$
$H_1$: $\mu_{defaulted} < \mu_{not defaulted}$

As per usual, we will use $\alpha$ = 0.05.


```{r}
RUN TEST HERE
```

INSERT COMMENTARY

Next, let's conduct our chi-square test for if home-ownership rates differ between those who default and those who don't. We set up our home_ownership hypotheses as follows:
$H_0$: Home Ownership Status and Loan Status are independent
$H_1$: Home Ownership Status and Loan Status not independent

As per usual, we will use $\alpha$ = 0.05.


```{r}
#To run test
chitest_housing = chisq.test(cont_table_housing)
#To output results
chitest_housing
```
INSERT COMMENTARY (USE THE RESULTS OUTPUT ABOVE TO GUAGE COMMENTARY, BUT USE INLINE TEXT FOR VALUES)

Next, we'll assess if marital status has an impact on default status. We set up our marital status hypotheses as follows:
$H_0$: Marital Status and Loan Status are independent
$H_1$: Marital Status and Loan Status not independent

As per usual, we will use $\alpha$ = 0.05.

```{r}
CHI_SQUARE TEST HERE
```

INSERT COMMENTARY

Now we'll move back to our quantitative variables and asses if years in current home is significantly different for those who have defaulted vs not defaulted. We set up our hypotheses for years in current home as follows:
$H_0$: $\mu_{defaulted} \geq \mu_{not defaulted}$
$H_1$: $\mu_{defaulted} = \mu_{not defaulted}$

As per usual, we will use $\alpha$ = 0.05.

```{r}
TEST HERE
```

INSERT COMMENTARY HERE


Now we'll examine overall job experience and if it differs between the two loan statuses. We set up our hypotheses for overall job experience as follows:
$H_0$: $\mu_{defaulted} = \mu_{not defaulted}$
$H_1$: $\mu_{defaulted} \neq \mu_{not defaulted}$

As per usual, we will use $\alpha$ = 0.05.

```{r}
TEST HERE
```

COMMENTARY HERE

We know overall job experience and years in current job are highly correlated, but it is still worth examining them separately even if we it is likely we'll see the same result. Our hypotheses for years in current job are as follows:
$H_0$: $\mu_{defaulted} = \mu_{not defaulted}$
$H_1$: $\mu_{defaulted} \neq \mu_{not defaulted}$

As per usual, we will use $\alpha$ = 0.05.

```{r}
TEST HERE
```

INSERT COMMENTARY

Lastly, we'll examine age and if customers who default on loans are significantly younger than those who do not. We'll set up our age hypotheses as follows:
$H_0$: $\mu_{defaulted} \geq \mu_{not defaulted}$
$H_1$: $\mu_{defaulted} < \mu_{not defaulted}$

As per usual, we will use $\alpha$ = 0.05.

```{r}
TEST HERE
```

INSERT COMMENTARY
	
FINAL COMMENTARY


CODE THAT MIGHT HELP:
INLINE:

R:
```{r pressure, echo=FALSE}
#Building a histogram
  #This will allow you to show two graphs at once if necessary

par(mfrow = c(2,1))

#Format: ggplot(DATASET, aes(x=VARIABLE))
#Format: labs(title = "INSERT TITLE", x="X VARIABLE NAME")

ggplot(admitted, aes(x=gpa)) + 
  geom_histogram(color="blue") +
  labs(title = "GPA Histogram Plot", x="GPA")


#Building a Q-Q Plot
#Formaat: qqnorm(DATA$VARIABLE, main = "OVERALL TITLE FOR PLOT", xlab = "Theoretical Quantiles", ylab = "Sample Quantiles") - don't change x and y labels

qqnorm(admitted$gpa, main = "Q-Q Plot of GPA for Admitted Students", xlab = "Theoretical Quantiles", ylab = "Sample Quantiles")

#Conducting a t-test
#Format: t.test(DATA1$VARIABLE, DATA2$VARIABLE)
#Conduct test
ttest2sample_gpa = t.test(rejected$gpa,admitted$gpa)
#Output results
ttest2sample_gpa

Chi-square test of independence:
  chitest = chisq.test(cont_table)
```
